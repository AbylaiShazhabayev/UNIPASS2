var senhaId=null,showSecretEnable=!1;$("#form").form({afterSave:function(e){e.errors||($("#modal").modal("hide"),dataTable.ajax.reload(showSecretEnable?showSecret(dataTable.rows({selected:!0}).data()[0]):null,!1))},afterDelete:function(e){e||(dataTable.ajax.reload(null,!1),showSecretEnable&&removeDivSecret())}}),$("#txtTipo").selectize({onChange:function(e){$("#form").find(".show").addClass("d-none").end().find(".show-"+e).removeClass("d-none")}});var options={ui:{container:".pwd-container",showVerdicts:!1,viewports:{progress:".pwstrength_viewport_progress"},progressExtraCssClasses:"progress-sm"}};$(".txtPassword").pwstrength(options),$("#generatePassword").pGenerator({bind:"click",passwordElement:"#txtPassword",specialChars:!1,onPasswordGenerated:function(){$("#txtPassword").change()}});var $pw=$("#txtPassword"),$t=$("#showPassword ").find("i");$("#showPassword").click(function(){"password"===$pw.attr("type")?($pw.attr("type","text"),$t.removeClass("fa-eye").addClass("fa-eye-slash")):($pw.attr("type","password"),$t.addClass("fa-eye").removeClass("fa-eye-slash"))}),$("#modal").on("shown.bs.modal",function(){$("#txtRecurso").focus()}).on("hidden.bs.modal",function(){$("#form").form().cancel()}),$(".filterBy").change(function(){dataTable.ajax.reload(),removeDivSecret()}),$(".filterByType").change(function(){dataTable.ajax.reload(),removeDivSecret()});var passwords=[],dataTable=$("#table").DataTable({pageLength:15,order:[1,"asc"],ajax:{url:"api/passwords",type:"GET",data:function(e){return total=0,amount=0,passwords=[],e.data_table=!0,e.filter_by=$(".filterBy:checked").val(),filterByFolder=$("#filterByFolder").jstree("get_selected"),$.isArray(filterByFolder)&&(e.filter_by_folder=filterByFolder),filterByType=[],$(".filterByType:checked").each(function(e,t){filterByType.push($(t).attr("data-id"))}),e.filter_by_type=filterByType,e}},select:{style:"single"},rowId:"id",dom:"<'row'<'col-9'f><'col-3'B>><'row rowTableSecret'<'col-12 colTableSecret'tr>><'card-footer d-flex align-items-center'ip>",buttons:[],columns:[{orderable:!1,width:"0",render:function(e,t,a){return'<a href="javascript:void(0)" id="favorite-'+a.id+'" title="Add to Favorites" onclick="event.stopPropagation();favorite('+a.id+');"><svg xmlns="http://www.w3.org/2000/svg" class="icon '+(a.favorite?"text-yellow":"text-muted")+'" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"></path><path d="M12 17.75l-6.172 3.245 1.179-6.873-4.993-4.867 6.9-1.002L12 2l3.086 6.253 6.9 1.002-4.993 4.867 1.179 6.873z"></path></svg></a>'}},{title:"Passwords",data:"name",width:"60%"},{data:"id",orderable:!1,className:"text-right",width:"40%",render:function(e,t,a){return[2,3,4,6,7].includes(a.type)?(delay(1e3).then(()=>getPassword(a)),'<div><input type="text" id="pass'+a.id+'" class="form-control txtPassword" name="password" maxlength="160" value="" disabled></div><div id="pwd-container'+a.id+'">   <div id="pwstrength_viewport_progress'+a.id+'"></div></div>'):'<span>Can not evaluate strengthㅤ</span><a href="javascript:void(0)" value="'+a.id+'" class="btn btn-white btn-icon btn-sm mr-2 show'+(a.can_view?"":"disabled")+'" title="View" '+(a.can_view?"":"disabled")+'><svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"></path><circle cx="12" cy="12" r="2"></circle><path d="M2 12l1.5 2a11 11 0 0 0 17 0l1.5 -2"></path><path d="M2 12l1.5 -2a11 11 0 0 1 17 0l1.5 2"></path></svg></a>'}}],drawCallback:function(){$('[data-toggle="popover"]').popover()}}),total=0,amount=0;function delay(e){return new Promise(t=>setTimeout(t,e))}function getPassword(e){$.request({url:"/api/passwords/"+e.id,after:function(t){if(t.password){let s=t.password,o="#pass"+e.id;$(o).val(s);var a={};if(a.ui={container:"#pwd-container"+e.id,showVerdicts:!1,viewports:{progress:"#pwstrength_viewport_progress"+e.id},progressExtraCssClasses:"progress-sm"},""==$("#pwstrength_viewport_progress"+e.id)[0].innerHTML){$(o).pwstrength(a);let r=$($("#pwstrength_viewport_progress"+e.id)[0]).children().children();console.log(r.width()/r.parent().width()*100),total+=r.width()/r.parent().width()*100,amount+=1,console.log(t);const i=formatDate(new Date(t.updated_at));console.log(i);let n="",l=r.width()/r.parent().width()*100,d="";l<25?(n="Weak",d="#dc3545"):l<50?(n="Medium",d="#ffc107"):l<75?(n="Good",d="#007bff"):(n="Secured",d="#28a745");let c="<div style='width: 70%; float:right'><span class='ml-4'>"+i+"</span><span class='ml-4' style='width: 35%; white-space: pre; float:right; color: "+d+" '><i class='fa-solid fa-shield-halved'></i>  "+n+"</span>";t.url&&(c+="<a id='link"+e.id+" ' target='_blank' href=' "+t.url+" ' class='float-right'><i class='fa-solid fa-arrow-up-right-from-square'></i></a>"),console.log();let h=total/amount;setBarPercentage(h=h.toPrecision(2));let p=$("tr#"+e.id+" > td");passwords.includes(s)&&(c+="<i style='font-size: 1.2rem; color: red; float:left' class='fa-solid fa-circle-exclamation alertooltip'><span class='tooltiptext'>Duplicate password</span></i>"),passwords.push(s),p[1].innerHTML+=c+"</div>"}}}})}function formatDate(e){const t=new Date-e,a=Math.floor(t/864e5);if(0===a){const e=Math.floor(t/36e5);if(0===e){const e=Math.floor(t/6e4);if(0===e){return Math.floor(t/1e3)+" seconds ago"}return e+" minutes ago"}return e+" hours ago"}return a+" days ago"}function create(){$("#modal").modal("show")}function edit(e){$("#modal").modal("show"),$("#form").form().open(e)}function remove(e){$("#form").form().delete(e)}function share(e){senhaId=e,$("#modalCompartilhar").modal("show")}function favorite(e){$.request({url:"/api/passwords/"+e+"/favorite",method:"POST",after:function(){$("#favorite-"+e).find("svg").toggleClass("text-yellow text-muted")}})}function showDivSecret(){$(".colTableSecret").removeClass("col-12").addClass("col-5"),$(".rowTableSecret").append('<div class="col-7" id="colDivShowSecret"><div class="card border-bottom-0 border-right-0 h-full" id="divShowSecret"></div></div>'),showSecretEnable=!0}function removeDivSecret(){$(".colTableSecret").removeClass("col-7").addClass("col-12"),$(".rowTableSecret").find("#colDivShowSecret").remove(),showSecretEnable=!1}function showSecret(e){let t=$(".rowTableSecret").find("#divShowSecret");t.empty(),t.append('<div class="loader my-auto mx-auto"></div>'),$.request({url:"/api/passwords/"+e.id,after:function(a){let s="",o="",r="",i=!1;s+='<div class="card-header border-0"><h3 class="card-title">'+a.name+'</h3><div class="card-actions"><a href="javascript:void(0)" class="btn btn-white btn-icon btn-sm pull-right" title="Close" onclick="removeDivSecret()"><svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"></path><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></a><a href="javascript:void(0)" class="btn btn-white btn-icon btn-sm pull-right mr-2 '+(e.can_delete?"":"disabled")+'" title="Delete" '+(e.can_delete?"":"disabled")+' onclick="remove('+e.id+')"><svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"></path><line x1="4" y1="7" x2="20" y2="7"></line><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line><path d="M5 7l1 12a2 2 0 0 0 2 2h8a2 2 0 0 0 2 -2l1 -12"></path><path d="M9 7v-3a1 1 0 0 1 1 -1h4a1 1 0 0 1 1 1v3"></path></svg></a><a href="javascript:void(0)" class="btn btn-white btn-icon btn-sm pull-right mr-2 '+(e.can_edit?"":"disabled")+'" title="Edit" '+(e.can_edit?"":"disabled")+' onclick="edit('+e.id+')"><svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"></path><path d="M4 20h4l10.5 -10.5a1.5 1.5 0 0 0 -4 -4l-10.5 10.5v4"></path><line x1="13.5" y1="6.5" x2="17.5" y2="10.5"></line></svg></a><a href="javascript:void(0)" class="btn btn-white btn-icon btn-sm pull-right mr-2 '+(e.can_share?"":"disabled")+'" title="Share" '+(e.can_share?"":"disabled")+' onclick="share('+e.id+')"><svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"></path><circle cx="6" cy="12" r="3"></circle><circle cx="18" cy="6" r="3"></circle><circle cx="18" cy="18" r="3"></circle><line x1="8.7" y1="10.7" x2="15.3" y2="7.3"></line><line x1="8.7" y1="13.3" x2="15.3" y2="16.7"></line></svg></a></div></div>',s+='<div class="card-body"><dl class="row">',s+='<dt class="col-4">Type:</dt><dd class="col-8">'+a.type_name+'</dd><dt class="col-4">Name: </dt><dd class="col-8">'+a.name+"</dd>",$("#form").find(".show-"+a.type).each(function(e){o=$(this).find("label").text(),r=$(this).find("input").attr("name"),i="password"===r,null!==a[r]&&(i&&(s+='<dt class="col-4">'+o+': </dt><dd class="col-8"><span class="pass-'+e+(i?"":" d-none")+' show">'+"*".repeat(a[r].length)+'</span><span class="pass-'+e+(i?" d-none":"")+' hidden" id="copy-'+e+'">'+a[r]+'</span><a href="javascript:void(0)" class="ml-2 showPass" data-index="'+e+'"><i class="fa fa-eye"></i></a><a href="javascript:void(0)" class="ml-2 copy" data-index="'+e+'"><i class="fa fa-copy"></i></a></dd>'),console.log(a[r]),s+="url"===r||"URL"===r?'<dt class="col-4 '+(i?"d-none":"")+'">'+o+': </dt><dd class="col-8 '+(i?"d-none":"")+'"><a href="'+a[r]+'" target="_blank" class="ml-2"><span id="copy-'+e+'">'+a[r]+'</span>ㅤ<i class="fa-solid fa-arrow-up-right-from-square"></i></a></dd>':'<dt class="col-4 '+(i?"d-none":"")+'">'+o+': </dt><dd class="col-8 '+(i?"d-none":"")+'"><span id="copy-'+e+'">'+a[r]+'</span><a href="javascript:void(0)" class="ml-2 copy" data-index="'+e+'"><i class="fa fa-copy"></a></i></dd>')}),null!==a.notes&&(s+='<dd class="col-12">'+a.notes+"</dd>"),s+="</dl></div>",t.empty(),t.append(s),t.on("click",".showPass",function(){let e=$(this),a=t.find(".pass-"+$(this).attr("data-index")+".show"),s=t.find(".pass-"+$(this).attr("data-index")+".hidden");e.find("i").removeClass("fa-eye").addClass("fa-eye-slash"),a.toggleClass("d-none"),s.toggleClass("d-none"),setTimeout(function(){e.find("i").removeClass("fa-eye-slash").addClass("fa-eye"),a.removeClass("d-none"),s.addClass("d-none")},3500)}),t.on("click",".copy",function(){let e=$(this);copy(t,t.find("#copy-"+$(this).attr("data-index")).text())&&(e.find("i").removeClass("fa-copy").addClass("fa-check-circle"),setTimeout(function(){e.find("i").removeClass("fa-check-circle").addClass("fa-copy")},500))})}})}function setBarPercentage(e){var t=$("#svg #bar");if(isNaN(e))e=0;else{var a=t.attr("r"),s=Math.PI*(2*a);e<0&&(e=0),e>100&&(e=100);let r=$("#statusText")[0],i=$("#bar");e<25?(i.css("stroke","red"),r.innerHTML="Unsecure: you need to change your passwords to more complicated combinations of symbols"):e<50?(i.css("stroke","orange"),r.innerHTML="Slightly secured: you need to change most of your passwords to more complicated combinations of symbols"):e<75?(i.css("stroke","blue"),r.innerHTML="Satisfied security: even though your passwords are pretty secured, you can change them to be more secured"):(i.css("stroke","green"),r.innerHTML="Secured: all of your passwords are pretty secured"),console.log($("#statusText")[0].innerHTML);var o=(100-e)/100*s;t.css({strokeDashoffset:o}),$("#cont").attr("data-pct",e)}}$("#table").on("click","tbody > tr",function(){let e=$(this);e.find("td").hasClass("dataTables_empty")||(e.hasClass("selected")?removeDivSecret():(showSecretEnable||showDivSecret(),showSecret(dataTable.row(this).data())))}),$.request({url:"/api/folders/compact",after:function(e){var t=[];$.each(e,function(e,a){t.push({id:a.id,parent:a.folder_id||"#",text:a.name})}),$("#filterByFolder").jstree({core:{data:t,animation:0,themes:{stripes:!1,icons:!1,dots:!1}},checkbox:{keep_selected_style:!1},plugins:["checkbox"]}).on("select_node.jstree",function(){dataTable.ajax.reload(),removeDivSecret()}).on("deselect_node.jstree",function(){dataTable.ajax.reload(),removeDivSecret()})}});